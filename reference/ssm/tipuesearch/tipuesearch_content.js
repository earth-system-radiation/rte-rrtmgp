var tipuesearch = {"pages":[{"title":" SSM optics ","text":"SSM optics These pages document the Simple Spectral Models of gas and cloud optics used by RTE-SSM. The gas optics is described in Williams (2026) and PR #379 , and includes simple analytic representations to the absorption coefficients of H( {2})O and CO( {2}) line absorption (in the longwave) and H( {2})O and O( {3}) line absorption (in the shortwave). The cloud optics is highly simplified and just prescribes a single mass absorption coefficient (\\kappa), single scattering albedo (\\omega_0), and asymmetry factor (g) for clouds in the longwave and shortwave, respectively. The listings below are not exhaustive.\nTo see the full listings use the links at the top of the page.\nThere is a search bar in the top right. Return to the Documentation overview or the reference overview . Developer Info The RTE+RRTTMGP consortium","tags":"home","loc":"index.html"},{"title":"ty_optics_ssm – SSM optics ","text":"type, public, extends(ty_gas_optics) :: ty_optics_ssm Inherits type~~ty_optics_ssm~~InheritsGraph type~ty_optics_ssm ty_optics_ssm ty_gas_optics ty_gas_optics type~ty_optics_ssm->ty_gas_optics Help × Graph Key Nodes of different colours represent the following: Graph Key Type Type This Page's Entity This Page's Entity Solid arrows point from a derived type to the parent type which it\n    extends. Dashed arrows point from a derived type to the other\n    types it contains as a components, with a label listing the name(s) of\n    said component(s). Contents Variables Tstar absorption_coeffs dnus g_cld gas_names kappa_cld m_dry mol_weights nus pref ssa_cld tsi Type-Bound Procedures cloud_optics configure gas_optics_ext gas_optics_int get_press_max get_press_min get_temp_max get_temp_min source_is_external source_is_internal Components Type Visibility Attributes Name Initial real(kind=wp), public :: Tstar = 0._wp real(kind=wp), public, dimension(:, :), allocatable :: absorption_coeffs real(kind=wp), public, dimension(:), allocatable :: dnus real(kind=wp), public :: g_cld = 0._wp character(len=32), public, dimension(:), allocatable :: gas_names real(kind=wp), public :: kappa_cld = 0._wp real(kind=wp), public :: m_dry = 0.029_wp real(kind=wp), public, dimension(:), allocatable :: mol_weights real(kind=wp), public, dimension(:), allocatable :: nus real(kind=wp), public :: pref = 500._wp*100._wp real(kind=wp), public :: ssa_cld = 0._wp real(kind=wp), public :: tsi = 0._wp Type-Bound Procedures procedure, public :: cloud_optics private function cloud_optics(this, clwp, ciwp, reliq, reice, optical_props) result(error_msg) Derive cloud optical properties from provided cloud physical properties Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this real(kind=wp), intent(in) :: clwp (:,:) real(kind=wp), intent(in) :: ciwp (:,:) real(kind=wp), intent(in) :: reliq (:,:) real(kind=wp), intent(in) :: reice (:,:) class(ty_optical_props_arry), intent(inout) :: optical_props Return Value character(len=128) generic, public :: configure => configure_with_values, configure_with_defaults private function configure_with_values(this, gas_names, triangle_params, nus, nu_min, nu_max, Tstar, tsi, kappa_cld, g_cld, ssa_cld) result(error_msg) Configure the simple spectral model parameters\nGas optics for simple spectral models are described as N triangles of ln(kappa) for\n  each of M gases.\nEach triangle id defined by\n   the absorption coefficient at central wavenumber, nu0\n   a central wavenumber nu0\n   the slope d ln(kappa)/d nu\nBy default there are two gases (h2o and co2) (for the LW).\n  h2o has three triangles (rotational lines, and a continuum with infinite slope)\n  co2 has a single triangle\nAbsorption coefficents are defined at pref and pressure-broadened as p/pref\nSpectral discretization is defined as\n  max and min wavenumbers and\n  a set of wavenumbers at which to evaluate absorption and Planck function\nIf Tstar is provided the gas optics are for insolation Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(inout) :: this character(len=32), intent(in), dimension(:) :: gas_names real(kind=wp), intent(in), dimension(:,:) :: triangle_params (ntriangles, 4) where the second dimension holds [gas_index, kappa0, nu0, l] real(kind=wp), intent(in), dimension(:) :: nus Wavenumbers at which to evaluate Planck function and absorption coefficient real(kind=wp), intent(in) :: nu_min Upper and lower bounds of spectrum real(kind=wp), intent(in) :: nu_max Upper and lower bounds of spectrum real(kind=wp), intent(in), optional :: Tstar Temperature for stellar insolation real(kind=wp), intent(in), optional :: tsi Total solar irradiance real(kind=wp), intent(in), optional :: kappa_cld real(kind=wp), intent(in), optional :: g_cld real(kind=wp), intent(in), optional :: ssa_cld cloud optical properties Return Value character(len=128) Empty if successful private function configure_with_defaults(this, do_sw) result(error_msg) Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(inout) :: this logical, intent(in), optional :: do_sw Return Value character(len=128) procedure, public :: gas_optics_ext private function gas_optics_ext(this, play, plev, tlay, gas_desc, optical_props, toa_src, col_dry) result(error_msg) Compute gas optical depth given temperature, pressure, and composition\n   Top-of-atmosphere stellar insolation is also reported Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this real(kind=wp), intent(in), dimension(:,:) :: play layer pressures [Pa]; (ncol,nlay)\nlevel pressures [Pa]; (ncol,nlay+1)\nlayer temperatures [K]; (ncol,nlay) real(kind=wp), intent(in), dimension(:,:) :: plev layer pressures [Pa]; (ncol,nlay)\nlevel pressures [Pa]; (ncol,nlay+1)\nlayer temperatures [K]; (ncol,nlay) real(kind=wp), intent(in), dimension(:,:) :: tlay layer pressures [Pa]; (ncol,nlay)\nlevel pressures [Pa]; (ncol,nlay+1)\nlayer temperatures [K]; (ncol,nlay) type(ty_gas_concs), intent(in) :: gas_desc Gas volume mixing ratios class(ty_optical_props_arry), intent(inout) :: optical_props real(kind=wp), intent(out), dimension(:,:) :: toa_src Incoming solar irradiance(ncol, nnu) real(kind=wp), intent(in), optional dimension(:,:), target :: col_dry Return Value character(len=128) Empty if successful procedure, public :: gas_optics_int private function gas_optics_int(this, play, plev, tlay, tsfc, gas_desc, optical_props, sources, col_dry, tlev) result(error_msg) Compute gas optical depth and Planck source functions,\n given temperature, pressure, and composition Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this real(kind=wp), intent(in), dimension(:,:) :: play layer pressures [Pa]; (ncol,nlay)\nlevel pressures [Pa]; (ncol,nlay+1)\nlayer temperatures [K]; (ncol,nlay) real(kind=wp), intent(in), dimension(:,:) :: plev layer pressures [Pa]; (ncol,nlay)\nlevel pressures [Pa]; (ncol,nlay+1)\nlayer temperatures [K]; (ncol,nlay) real(kind=wp), intent(in), dimension(:,:) :: tlay layer pressures [Pa]; (ncol,nlay)\nlevel pressures [Pa]; (ncol,nlay+1)\nlayer temperatures [K]; (ncol,nlay) real(kind=wp), intent(in), dimension(:) :: tsfc surface skin temperatures [K]; (ncol) type(ty_gas_concs), intent(in) :: gas_desc Gas volume mixing ratios class(ty_optical_props_arry), intent(inout) :: optical_props Optical properties class(ty_source_func_lw), intent(inout) :: sources Planck sources real(kind=wp), intent(in), optional dimension(:,:), target :: col_dry Column dry amount; dim(ncol,nlay), will be ignored\nlevel temperatures [K]; (ncol,nlay+1) real(kind=wp), intent(in), optional dimension(:,:), target :: tlev Column dry amount; dim(ncol,nlay), will be ignored\nlevel temperatures [K]; (ncol,nlay+1) Return Value character(len=128) Empty if succssful procedure, public :: get_press_max private pure function get_press_max(this) Maximum valid pressure Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this Return Value real(kind=wp) maximum valid pressure procedure, public :: get_press_min private pure function get_press_min(this) Minimum valid pressure Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this Return Value real(kind=wp) minimum valid pressure procedure, public :: get_temp_max private pure function get_temp_max(this) Maximum valid pressure Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this Return Value real(kind=wp) maximum valid pressure procedure, public :: get_temp_min private pure function get_temp_min(this) Minimum valid temperature Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this Return Value real(kind=wp) minimum valid temperature procedure, public :: source_is_external private pure function source_is_external(this) return true if configured for external sources/shortwave, false otherwise Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this Return Value logical procedure, public :: source_is_internal private pure function source_is_internal(this) return true if initialized for internal sources/longwave, false otherwise Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(in) :: this Return Value logical","tags":"","loc":"type/ty_optics_ssm.html"},{"title":"compute_tau – SSM optics","text":"public subroutine compute_tau(ncol, nlay, nnu, ngas, absorption_coeffs, play, pref, layer_mass, tau) bind(C, name=\"0\") Arguments Type Intent Optional Attributes Name integer, intent(in) :: ncol integer, intent(in) :: nlay integer, intent(in) :: nnu integer, intent(in) :: ngas real(kind=wp), intent(in), dimension(ngas, nnu) :: absorption_coeffs real(kind=wp), intent(in), dimension(ncol, nlay) :: play layer pressures [Pa]; (ncol,nlay) real(kind=wp), intent(in) :: pref reference pressure [Pa], do foreign broadening if this is non-zero real(kind=wp), intent(in), dimension(ngas, ncol, nlay) :: layer_mass !! mass of atm layer [kg/m2]; (ngas, ncol, nlay) real(kind=wp), intent(out), dimension(ncol, nlay, nnu) :: tau Contents None","tags":"","loc":"proc/compute_tau.html"},{"title":"compute_Planck_source – SSM optics","text":"public interface compute_Planck_source Contents Module Procedures compute_Planck_source_1D compute_Planck_source_2D Module Procedures private subroutine compute_Planck_source_1D(ncol, nnu, nus, dnus, T, source) bind(C, name=\"0\") Arguments Type Intent Optional Attributes Name integer, intent(in) :: ncol integer, intent(in) :: nnu real(kind=wp), intent(in), dimension(nnu) :: nus real(kind=wp), intent(in), dimension(nnu) :: dnus real(kind=wp), intent(in), dimension(ncol) :: T real(kind=wp), intent(out), dimension(ncol, nnu) :: source private subroutine compute_Planck_source_2D(ncol, nlay, nnu, nus, dnus, T, source) bind(C, name=\"0\") Arguments Type Intent Optional Attributes Name integer, intent(in) :: ncol integer, intent(in) :: nlay integer, intent(in) :: nnu real(kind=wp), intent(in), dimension(nnu) :: nus real(kind=wp), intent(in), dimension(nnu) :: dnus real(kind=wp), intent(in), dimension(ncol, nlay) :: T real(kind=wp), intent(out), dimension(ncol, nlay, nnu) :: source","tags":"","loc":"interface/compute_planck_source.html"},{"title":"configure – SSM optics","text":"public interface configure Contents Module Procedures configure_with_values configure_with_defaults Module Procedures private function configure_with_values(this, gas_names, triangle_params, nus, nu_min, nu_max, Tstar, tsi, kappa_cld, g_cld, ssa_cld) result(error_msg) Configure the simple spectral model parameters\nGas optics for simple spectral models are described as N triangles of ln(kappa) for\n  each of M gases.\nEach triangle id defined by\n   the absorption coefficient at central wavenumber, nu0\n   a central wavenumber nu0\n   the slope d ln(kappa)/d nu\nBy default there are two gases (h2o and co2) (for the LW).\n  h2o has three triangles (rotational lines, and a continuum with infinite slope)\n  co2 has a single triangle\nAbsorption coefficents are defined at pref and pressure-broadened as p/pref\nSpectral discretization is defined as\n  max and min wavenumbers and\n  a set of wavenumbers at which to evaluate absorption and Planck function\nIf Tstar is provided the gas optics are for insolation Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(inout) :: this character(len=32), intent(in), dimension(:) :: gas_names real(kind=wp), intent(in), dimension(:,:) :: triangle_params (ntriangles, 4) where the second dimension holds [gas_index, kappa0, nu0, l] real(kind=wp), intent(in), dimension(:) :: nus Wavenumbers at which to evaluate Planck function and absorption coefficient real(kind=wp), intent(in) :: nu_min Upper and lower bounds of spectrum real(kind=wp), intent(in) :: nu_max Upper and lower bounds of spectrum real(kind=wp), intent(in), optional :: Tstar Temperature for stellar insolation real(kind=wp), intent(in), optional :: tsi Total solar irradiance real(kind=wp), intent(in), optional :: kappa_cld real(kind=wp), intent(in), optional :: g_cld real(kind=wp), intent(in), optional :: ssa_cld cloud optical properties Return Value character(len=128) Empty if successful private function configure_with_defaults(this, do_sw) result(error_msg) Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(inout) :: this logical, intent(in), optional :: do_sw Return Value character(len=128)","tags":"","loc":"interface/configure.html"},{"title":"mo_optics_ssm_kernels – SSM optics","text":"Kernels Details here Uses mo_rte_util_array mo_rte_kind module~~mo_optics_ssm_kernels~~UsesGraph module~mo_optics_ssm_kernels mo_optics_ssm_kernels mo_rte_util_array mo_rte_util_array module~mo_optics_ssm_kernels->mo_rte_util_array mo_rte_kind mo_rte_kind module~mo_optics_ssm_kernels->mo_rte_kind Help × Graph Key Nodes of different colours represent the following: Graph Key Module Module Submodule Submodule Subroutine Subroutine Function Function Program Program This Page's Entity This Page's Entity Solid arrows point from a submodule to the (sub)module which it is\n    descended from. Dashed arrows point from a module or program unit to \n    modules which it uses. Used by module~~mo_optics_ssm_kernels~~UsedByGraph module~mo_optics_ssm_kernels mo_optics_ssm_kernels module~mo_optics_ssm mo_optics_ssm module~mo_optics_ssm->module~mo_optics_ssm_kernels Help × Graph Key Nodes of different colours represent the following: Graph Key Module Module Submodule Submodule Subroutine Subroutine Function Function Program Program This Page's Entity This Page's Entity Solid arrows point from a submodule to the (sub)module which it is\n    descended from. Dashed arrows point from a module or program unit to \n    modules which it uses. Contents Interfaces compute_Planck_source Subroutines compute_tau Interfaces public interface compute_Planck_source private subroutine compute_Planck_source_1D(ncol, nnu, nus, dnus, T, source) bind(C, name=\"0\") Arguments Type Intent Optional Attributes Name integer, intent(in) :: ncol integer, intent(in) :: nnu real(kind=wp), intent(in), dimension(nnu) :: nus real(kind=wp), intent(in), dimension(nnu) :: dnus real(kind=wp), intent(in), dimension(ncol) :: T real(kind=wp), intent(out), dimension(ncol, nnu) :: source private subroutine compute_Planck_source_2D(ncol, nlay, nnu, nus, dnus, T, source) bind(C, name=\"0\") Arguments Type Intent Optional Attributes Name integer, intent(in) :: ncol integer, intent(in) :: nlay integer, intent(in) :: nnu real(kind=wp), intent(in), dimension(nnu) :: nus real(kind=wp), intent(in), dimension(nnu) :: dnus real(kind=wp), intent(in), dimension(ncol, nlay) :: T real(kind=wp), intent(out), dimension(ncol, nlay, nnu) :: source Subroutines public subroutine compute_tau (ncol, nlay, nnu, ngas, absorption_coeffs, play, pref, layer_mass, tau) bind(C, name=\"0\") Arguments Type Intent Optional Attributes Name integer, intent(in) :: ncol integer, intent(in) :: nlay integer, intent(in) :: nnu integer, intent(in) :: ngas real(kind=wp), intent(in), dimension(ngas, nnu) :: absorption_coeffs real(kind=wp), intent(in), dimension(ncol, nlay) :: play layer pressures [Pa]; (ncol,nlay) real(kind=wp), intent(in) :: pref reference pressure [Pa], do foreign broadening if this is non-zero real(kind=wp), intent(in), dimension(ngas, ncol, nlay) :: layer_mass !! mass of atm layer [kg/m2]; (ngas, ncol, nlay) real(kind=wp), intent(out), dimension(ncol, nlay, nnu) :: tau","tags":"","loc":"module/mo_optics_ssm_kernels.html"},{"title":"mo_optics_ssm – SSM optics","text":"Class implementing Simple Spectral model gas optics Details here Uses mo_gas_concentrations mo_rte_util_array_validation mo_optical_props mo_rte_config mo_rte_util_array mo_rte_kind mo_source_functions mo_optics_ssm_kernels mo_gas_optics_constants mo_gas_optics mo_gas_optics_util_string module~~mo_optics_ssm~~UsesGraph module~mo_optics_ssm mo_optics_ssm mo_gas_concentrations mo_gas_concentrations module~mo_optics_ssm->mo_gas_concentrations mo_rte_config mo_rte_config module~mo_optics_ssm->mo_rte_config mo_rte_util_array mo_rte_util_array module~mo_optics_ssm->mo_rte_util_array mo_rte_kind mo_rte_kind module~mo_optics_ssm->mo_rte_kind mo_gas_optics mo_gas_optics module~mo_optics_ssm->mo_gas_optics mo_optical_props mo_optical_props module~mo_optics_ssm->mo_optical_props mo_rte_util_array_validation mo_rte_util_array_validation module~mo_optics_ssm->mo_rte_util_array_validation mo_source_functions mo_source_functions module~mo_optics_ssm->mo_source_functions module~mo_optics_ssm_kernels mo_optics_ssm_kernels module~mo_optics_ssm->module~mo_optics_ssm_kernels mo_gas_optics_constants mo_gas_optics_constants module~mo_optics_ssm->mo_gas_optics_constants mo_gas_optics_util_string mo_gas_optics_util_string module~mo_optics_ssm->mo_gas_optics_util_string module~mo_optics_ssm_kernels->mo_rte_util_array module~mo_optics_ssm_kernels->mo_rte_kind Help × Graph Key Nodes of different colours represent the following: Graph Key Module Module Submodule Submodule Subroutine Subroutine Function Function Program Program This Page's Entity This Page's Entity Solid arrows point from a submodule to the (sub)module which it is\n    descended from. Dashed arrows point from a module or program unit to \n    modules which it uses. Contents Variables Tsun_ssm g_cld_lw g_cld_sw kappa_cld_lw kappa_cld_sw mw_co2 mw_h2o mw_o3 ssa_cld_lw ssa_cld_sw tsi Interfaces configure Derived Types ty_optics_ssm Variables Type Visibility Attributes Name Initial real(kind=wp), public, parameter :: Tsun_ssm = 5760._wp real(kind=wp), public, parameter :: g_cld_lw = 0._wp real(kind=wp), public, parameter :: g_cld_sw = 0.85_wp real(kind=wp), public, parameter :: kappa_cld_lw = 50._wp real(kind=wp), public, parameter :: kappa_cld_sw = 0.0001_wp real(kind=wp), public, parameter :: mw_co2 = 0.044_wp real(kind=wp), public, parameter :: mw_h2o = 0.018_wp real(kind=wp), public, parameter :: mw_o3 = 0.048_wp real(kind=wp), public, parameter :: ssa_cld_lw = 0._wp real(kind=wp), public, parameter :: ssa_cld_sw = 0.9999_wp real(kind=wp), public, parameter :: tsi = 1360._wp Interfaces public interface configure private function configure_with_values(this, gas_names, triangle_params, nus, nu_min, nu_max, Tstar, tsi, kappa_cld, g_cld, ssa_cld) result(error_msg) Configure the simple spectral model parameters\nGas optics for simple spectral models are described as N triangles of ln(kappa) for\n  each of M gases.\nEach triangle id defined by\n   the absorption coefficient at central wavenumber, nu0\n   a central wavenumber nu0\n   the slope d ln(kappa)/d nu\nBy default there are two gases (h2o and co2) (for the LW).\n  h2o has three triangles (rotational lines, and a continuum with infinite slope)\n  co2 has a single triangle\nAbsorption coefficents are defined at pref and pressure-broadened as p/pref\nSpectral discretization is defined as\n  max and min wavenumbers and\n  a set of wavenumbers at which to evaluate absorption and Planck function\nIf Tstar is provided the gas optics are for insolation Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(inout) :: this character(len=32), intent(in), dimension(:) :: gas_names real(kind=wp), intent(in), dimension(:,:) :: triangle_params (ntriangles, 4) where the second dimension holds [gas_index, kappa0, nu0, l] real(kind=wp), intent(in), dimension(:) :: nus Wavenumbers at which to evaluate Planck function and absorption coefficient real(kind=wp), intent(in) :: nu_min Upper and lower bounds of spectrum real(kind=wp), intent(in) :: nu_max Upper and lower bounds of spectrum real(kind=wp), intent(in), optional :: Tstar Temperature for stellar insolation real(kind=wp), intent(in), optional :: tsi Total solar irradiance real(kind=wp), intent(in), optional :: kappa_cld real(kind=wp), intent(in), optional :: g_cld real(kind=wp), intent(in), optional :: ssa_cld cloud optical properties Return Value character(len=128) Empty if successful private function configure_with_defaults(this, do_sw) result(error_msg) Arguments Type Intent Optional Attributes Name class( ty_optics_ssm ), intent(inout) :: this logical, intent(in), optional :: do_sw Return Value character(len=128) Derived Types type, public, extends(ty_gas_optics) :: ty_optics_ssm Components Type Visibility Attributes Name Initial real(kind=wp), public :: Tstar = 0._wp real(kind=wp), public, dimension(:, :), allocatable :: absorption_coeffs real(kind=wp), public, dimension(:), allocatable :: dnus real(kind=wp), public :: g_cld = 0._wp character(len=32), public, dimension(:), allocatable :: gas_names real(kind=wp), public :: kappa_cld = 0._wp real(kind=wp), public :: m_dry = 0.029_wp real(kind=wp), public, dimension(:), allocatable :: mol_weights real(kind=wp), public, dimension(:), allocatable :: nus real(kind=wp), public :: pref = 500._wp*100._wp real(kind=wp), public :: ssa_cld = 0._wp real(kind=wp), public :: tsi = 0._wp Type-Bound Procedures procedure, public :: cloud_optics generic, public :: configure => configure_with_values, configure_with_defaults procedure, public :: gas_optics_ext procedure, public :: gas_optics_int procedure, public :: get_press_max procedure, public :: get_press_min procedure, public :: get_temp_max procedure, public :: get_temp_min procedure, public :: source_is_external procedure, public :: source_is_internal","tags":"","loc":"module/mo_optics_ssm.html"},{"title":"mo_optics_ssm_kernels.F90 – SSM optics","text":"Files dependent on this one sourcefile~~mo_optics_ssm_kernels.f90~~AfferentGraph sourcefile~mo_optics_ssm_kernels.f90 mo_optics_ssm_kernels.F90 sourcefile~mo_optics_ssm.f90 mo_optics_ssm.F90 sourcefile~mo_optics_ssm.f90->sourcefile~mo_optics_ssm_kernels.f90 Help × Graph Key Nodes of different colours represent the following: Graph Key Source File Source File This Page's Entity This Page's Entity Solid arrows point from a file to a file which it depends on. A file\n    is dependent upon another if the latter must be compiled before the former\n    can be. Contents Modules mo_optics_ssm_kernels Source Code mo_optics_ssm_kernels.F90 Source Code ! See documentation in other modules... ! ! Contacts: Andrew Williams and Robert Pincus ! email:  andrewwilliams@ucsd.edu ! ! Contacts: could provide here... names, emails or web site ! ! Copyright 2025-,  ... Trustees of Columbia University.  All right reserved. ! ! Use and duplication is permitted under the terms of the !    BSD 3-clause license, see http://opensource.org/licenses/BSD-3-Clause ! ------------------------------------------------------------------------------------------------- ! !> ## Kernels !> !> Details here ! ------------------------------------------------------------------------------------------------- module mo_optics_ssm_kernels use mo_rte_kind , only : wp , wl use mo_rte_util_array , only : zero_array implicit none interface compute_Planck_source module procedure compute_Planck_source_1D , compute_Planck_source_2D end interface private public :: compute_tau , compute_Planck_source ! ! Physical constants ! real ( wp ), parameter :: planck_h = 6.626075540e-34_wp ! Planck's constant real ( wp ), parameter :: lightspeed = 2.99792458e8_wp ! Speed of light real ( wp ), parameter :: boltzmann_k = 1.38065812e-23_wp ! Boltzman thermodynamic constant contains ! ! Computes optical depth from atmospheric state and gas optics ! subroutine compute_tau ( ncol , nlay , nnu , ngas , & absorption_coeffs , play , pref , layer_mass , & tau ) bind ( C , name = \"ssm_compute_tau_absorption\" ) integer , & intent ( in ) :: ncol , nlay , nnu , ngas real ( wp ), dimension ( ngas , nnu ), & intent ( in ) :: absorption_coeffs real ( wp ), dimension ( ncol , nlay ), & intent ( in ) :: play !! layer pressures [Pa]; (ncol,nlay) real ( wp ), dimension ( ngas , ncol , nlay ), & intent ( in ) :: layer_mass !! !! mass of atm layer [kg/m2]; (ngas, ncol, nlay) real ( wp ), & intent ( in ) :: pref !! reference pressure [Pa], do foreign broadening if this is non-zero real ( wp ), dimension ( ncol , nlay , nnu ), & intent ( out ) :: tau ! Local variables integer :: icol , ilay , inu , igas real ( wp ), dimension ( size ( play , 1 ), size ( play , 2 )) :: p_scaling ! Apply pressure broadening if pref input is non-zero if ( pref /= 0._wp ) then p_scaling (:,:) = play (:,:) / pref else p_scaling (:,:) = 1._wp end if do inu = 1 , nnu do ilay = 1 , nlay do icol = 1 , ncol tau ( icol , ilay , inu ) = & p_scaling ( icol , ilay ) * sum ( [( layer_mass ( igas , icol , ilay ) * absorption_coeffs ( igas , inu ), igas = 1 , ngas )] ) end do end do end do end subroutine compute_tau ! ------------------------------------------------------------------------------------------------- ! ! Planck function (gets wrapped by 1D, 2D codes) ! elemental function B_nu ( T , nu ) real ( wp ), intent ( in ) :: T , nu real ( wp ) :: B_nu B_nu = 10 0._wp * 2._wp * planck_h * (( nu * 10 0._wp ) ** 3 ) * ( lightspeed ** 2 ) / & ( exp (( planck_h * lightspeed * nu * 10 0._wp ) / ( boltzmann_k * T )) - 1._wp ) end function ! ------- subroutine compute_Planck_source_2D (& ncol , nlay , nnu , & nus , dnus , T , & source ) bind ( C , name = \"ssm_compute_Planck_source_2D\" ) integer , & intent ( in ) :: ncol , nlay , nnu real ( wp ), dimension ( nnu ), & intent ( in ) :: nus , dnus real ( wp ), dimension ( ncol , nlay ), & intent ( in ) :: T real ( wp ), dimension ( ncol , nlay , nnu ), & intent ( out ) :: source ! Local variables integer :: icol , ilay , inu do inu = 1 , nnu do ilay = 1 , nlay do icol = 1 , ncol source ( icol , ilay , inu ) = B_nu ( T ( icol , ilay ), nus ( inu )) * dnus ( inu ) end do end do end do end subroutine compute_Planck_source_2D ! ------- subroutine compute_Planck_source_1D (& ncol , nnu , & nus , dnus , T , & source ) bind ( C , name = \"ssm_compute_Planck_source_1D\" ) integer , & intent ( in ) :: ncol , nnu real ( wp ), dimension ( nnu ), & intent ( in ) :: nus , dnus real ( wp ), dimension ( ncol ), & intent ( in ) :: T real ( wp ), dimension ( ncol , nnu ), & intent ( out ) :: source ! Local variables integer :: icol , ilay , inu do inu = 1 , nnu do icol = 1 , ncol source ( icol , inu ) = B_nu ( T ( icol ), nus ( inu )) * dnus ( inu ) end do end do end subroutine compute_Planck_source_1D ! ------- end module mo_optics_ssm_kernels","tags":"","loc":"sourcefile/mo_optics_ssm_kernels.f90.html"},{"title":"mo_optics_ssm.F90 – SSM optics","text":"This file depends on sourcefile~~mo_optics_ssm.f90~~EfferentGraph sourcefile~mo_optics_ssm.f90 mo_optics_ssm.F90 sourcefile~mo_optics_ssm_kernels.f90 mo_optics_ssm_kernels.F90 sourcefile~mo_optics_ssm.f90->sourcefile~mo_optics_ssm_kernels.f90 Help × Graph Key Nodes of different colours represent the following: Graph Key Source File Source File This Page's Entity This Page's Entity Solid arrows point from a file to a file which it depends on. A file\n    is dependent upon another if the latter must be compiled before the former\n    can be. Contents Modules mo_optics_ssm Source Code mo_optics_ssm.F90 Source Code ! See documentation in other modules... ! ! Contacts: Andrew Williams and Robert Pincus ! email:  andrewwilliams@ucsd.edu ! ! Copyright 2025-,  ... Trustees of Columbia University.  All right reserved. ! ! Use and duplication is permitted under the terms of the !    BSD 3-clause license, see http://opensource.org/licenses/BSD-3-Clause ! ------------------------------------------------------------------------------------------------- ! !> ## Class implementing Simple Spectral model gas optics !> !> Details here ! ------------------------------------------------------------------------------------------------- module mo_optics_ssm use mo_rte_kind , only : wp , wl use mo_rte_config , only : check_extents , check_values use mo_rte_util_array , only : zero_array use mo_rte_util_array_validation , & only : any_vals_less_than , any_vals_outside , extents_are use mo_optical_props , only : ty_optical_props use mo_source_functions , only : ty_source_func_lw use mo_gas_optics_util_string , only : lower_case , string_in_array , string_loc_in_array use mo_gas_concentrations , only : ty_gas_concs use mo_optical_props , only : ty_optical_props_arry , & ty_optical_props_1scl , ty_optical_props_2str , ty_optical_props_nstr use mo_gas_optics , only : ty_gas_optics use mo_gas_optics_constants , only : grav use mo_optics_ssm_kernels , only : compute_tau , compute_Planck_source implicit none interface configure module procedure configure_with_values , configure_with_defaults end interface private public :: configure real ( wp ), parameter , public :: Tsun_ssm = 576 0._wp ! Default sun temperature for SSM real ( wp ), parameter , public :: tsi = 136 0._wp ! Default total solar irradiance real ( wp ), parameter , public :: mw_h2o = 0.018_wp ! Molecular weight h2o real ( wp ), parameter , public :: mw_co2 = 0.044_wp ! Molecular weight co2 real ( wp ), parameter , public :: mw_o3 = 0.048_wp ! Molecular weight o3 real ( wp ), parameter , public :: kappa_cld_lw = 5 0._wp ! Default for lw cloud absorption coefficient (m2/kg) real ( wp ), parameter , public :: kappa_cld_sw = 0.0001_wp ! Default for sw cloud absorption coefficient (m2/kg) real ( wp ), parameter , public :: ssa_cld_lw = 0._wp ! Default for lw cloud single scattering albedo real ( wp ), parameter , public :: ssa_cld_sw = 0.9999_wp ! Default for sw cloud single scattering albedo real ( wp ), parameter , public :: g_cld_lw = 0._wp ! Default for lw cloud asymmetry real ( wp ), parameter , public :: g_cld_sw = 0.85_wp ! Default for sw cloud asymmetry ! Default wavenumber arrays integer :: i integer , parameter :: nnu_def = 41 ! Default nnu real ( wp ), parameter :: nu_min_lw_def = 0._wp ! cm⁻¹ real ( wp ), parameter :: nu_max_lw_def = 350 0._wp ! cm⁻¹ real ( wp ), parameter :: nu_min_sw_def = 0._wp ! cm⁻¹ real ( wp ), parameter :: nu_max_sw_def = 5000 0._wp ! cm⁻¹ real ( wp ), dimension ( nnu_def ), parameter :: nus_lw_def = & [( 5 0._wp + ( i - 1 ) * ( 300 0._wp - 5 0._wp ) / ( nnu_def - 1 ), i = 1 , nnu_def )] ! Default wavenumber array, LW real ( wp ), dimension ( nnu_def ), parameter :: nus_sw_def = & [( 100 0._wp + ( i - 1 ) * ( 4500 0._wp - 100 0._wp ) / ( nnu_def - 1 ), i = 1 , nnu_def )] ! Default wavenumber array, SW ! Default spectoscopic params real ( wp ), dimension ( 4 , 4 ), parameter :: triangle_params_def_lw = reshape ( & [ 1._wp , 29 8._wp , 0._wp , 6 4._wp , & 1._wp , 1 2._wp , 160 0._wp , 3 6._wp , & 1._wp , 1 6._wp , 160 0._wp , 5 4._wp , & 2._wp , 11 0._wp , 66 7._wp , 1 2._wp ], & shape = [ 4 , 4 ], order = [ 2 , 1 ]) character ( len = 32 ), dimension ( 2 ), parameter :: gas_names_def_lw = [ character ( 32 ) :: \"h2o\" , \"co2\" ] real ( wp ), dimension ( 2 , 4 ), parameter :: triangle_params_def_sw = reshape ( & [ 1._wp , 1._wp , 0._wp , 120 0._wp , & 2._wp , 0._wp , 0._wp , 100000 0._wp ], & ! No O3 triangle for now, todo shape = [ 2 , 4 ], order = [ 2 , 1 ]) character ( len = 32 ), dimension ( 2 ), parameter :: gas_names_def_sw = [ character ( 32 ) :: \"h2o\" , \"o3\" ] ! ! ! ------------------------------------------------------------------------------------------------- type , extends ( ty_gas_optics ), public :: ty_optics_ssm private character ( 32 ), dimension (:), allocatable :: gas_names real ( wp ), dimension (:), allocatable :: mol_weights real ( wp ), dimension (:, :), allocatable :: absorption_coeffs real ( wp ), dimension (:), allocatable :: nus , dnus ! total absorption coefficients at spectral points (nnus, ngases) real ( wp ) :: Tstar = 0._wp , & pref = 50 0._wp * 10 0._wp , & ! reference pressure, assumes 500 hPa by default m_dry = 0.029_wp , & ! molecular weight of dry air [kg/mol] tsi = 0._wp , & ! total solar irradiance kappa_cld = 0._wp , & ! cloud absorption coefficient [m2/kg] g_cld = 0._wp , & ! cloud asymmetry factor ssa_cld = 0._wp ! cloud single scattering albedo contains procedure , private :: configure_with_values procedure , private :: configure_with_defaults generic , public :: configure => configure_with_values , configure_with_defaults procedure , public :: gas_optics_int procedure , public :: gas_optics_ext procedure , public :: cloud_optics procedure , public :: source_is_internal procedure , public :: source_is_external procedure , public :: get_press_min procedure , public :: get_press_max procedure , public :: get_temp_min procedure , public :: get_temp_max end type ty_optics_ssm contains !-------------------------------------------------------------------------------------------------------------------- function configure_with_defaults ( this , do_sw ) result ( error_msg ) class ( ty_optics_ssm ), intent ( inout ) :: this logical , optional , intent ( in ) :: do_sw ! Configure with SW defaults? Else LW character ( len = 128 ) :: error_msg logical :: do_sw_local do_sw_local = . false . if ( present ( do_sw )) do_sw_local = do_sw if (. not . do_sw_local ) then error_msg = this % configure_with_values ( gas_names_def_lw , triangle_params_def_lw , & nus_lw_def , nu_min_lw_def , nu_max_lw_def , & kappa_cld = kappa_cld_lw , g_cld = g_cld_lw , ssa_cld = ssa_cld_lw ) else error_msg = this % configure_with_values ( gas_names_def_sw , triangle_params_def_sw , & nus_sw_def , nu_min_sw_def , nu_max_sw_def , & Tstar = Tsun_ssm , tsi = tsi , & kappa_cld = kappa_cld_sw , g_cld = g_cld_sw , ssa_cld = ssa_cld_sw ) end if end function configure_with_defaults !-------------------------------------------------------------------------------------------------------------------- ! !> Configure the simple spectral model parameters !> Gas optics for simple spectral models are described as N triangles of ln(kappa) for !>   each of M gases. !> Each triangle id defined by !>    the absorption coefficient at central wavenumber, nu0 !>    a central wavenumber nu0 !>    the slope d ln(kappa)/d nu !> By default there are two gases (h2o and co2) (for the LW). !>   h2o has three triangles (rotational lines, and a continuum with infinite slope) !>   co2 has a single triangle !> Absorption coefficents are defined at pref and pressure-broadened as p/pref !> Spectral discretization is defined as !>   max and min wavenumbers and !>   a set of wavenumbers at which to evaluate absorption and Planck function !> If Tstar is provided the gas optics are for insolation ! function configure_with_values ( this , & gas_names , triangle_params , & nus , nu_min , nu_max , & Tstar , tsi , & kappa_cld , g_cld , ssa_cld ) result ( error_msg ) ! ! class ( ty_optics_ssm ), intent ( inout ) :: this character ( 32 ), dimension (:), intent ( in ) :: gas_names real ( wp ), dimension (:,:), intent ( in ) :: triangle_params !! (ntriangles, 4) where the second dimension holds [gas_index, kappa0, nu0, l] real ( wp ), dimension (:), intent ( in ) :: nus !! Wavenumbers at which to evaluate Planck function and absorption coefficient real ( wp ), intent ( in ) :: nu_min , nu_max !! Upper and lower bounds of spectrum real ( wp ), optional , intent ( in ) :: Tstar !! Temperature for stellar insolation real ( wp ), optional , intent ( in ) :: tsi !! Total solar irradiance real ( wp ), optional , intent ( in ) :: kappa_cld real ( wp ), optional , intent ( in ) :: g_cld real ( wp ), optional , intent ( in ) :: ssa_cld !! cloud optical properties character ( len = 128 ) :: error_msg !! Empty if successful ! ---------------------------------------------------------- ! Local variables ! ---------------------------------------------------------- integer :: nnu , ngas integer :: inu , itri , igas real ( wp ), dimension ( 2 , size ( nus )) :: band_lims_wavenum error_msg = \"\" ngas = size ( gas_names ) nnu = size ( nus ) ! ! Input sanitizing ! triangle params: index <= ngases, kappa0 >= 0; nu_min < nu0s < nu_max; l > 0 ! nu_min <= nus <= max_nu ! Tstar > 0 if specified ! if (. not . all ( nus > nu_min . and . nus < nu_max )) then error_msg = \"ssm_gas_optics(): nu must be less than nu_max and greater than nu_min\" end if if ( present ( Tstar )) then if ( Tstar <= 0.0_wp ) then error_msg = \"ssm_gas_optics(): if specified Tstar must be > 0\" end if end if if ( present ( tsi )) then if ( tsi <= 0.0_wp ) then error_msg = \"ssm_gas_optics(): if specified tsi must be > 0\" end if end if ! Validate gas indices in triangle_params if (. not . all ( triangle_params (:, 1 ) >= 1._wp . and . & triangle_params (:, 1 ) <= real ( ngas , wp ) . and . & triangle_params (:, 1 ) == floor ( triangle_params (:, 1 )))) then error_msg = \"ssm_gas_optics(): gas index in triangle_params must be integer >= 1 and <= ngas\" return end if if (. not . all ( triangle_params (:, 2 ) >= 0.0_wp )) then error_msg = \"ssm_gas_optics(): kappa0 needs to be >=0\" end if if (. not . all ( triangle_params (:, 4 ) > 0.0_wp )) then error_msg = \"ssm_gas_optics(): l needs to be > 0\" end if if ( error_msg /= '' ) return if ( allocated ( this % gas_names )) & deallocate ( this % gas_names , this % mol_weights , this % nus , this % dnus , this % absorption_coeffs ) allocate ( this % gas_names ( ngas ), & this % mol_weights ( ngas ), & this % nus ( nnu ), & this % dnus ( nnu ), & this % absorption_coeffs ( ngas , nnu ) ) this % nus ( 1 : nnu ) = nus ( 1 : nnu ) this % gas_names ( 1 : ngas ) = gas_names ( 1 : ngas ) ! ! Spectral discretization - edges of \"bands\" ! Then construct the band limits (place edges at midpoints between nus values): ! ! First band: starts at nu_min band_lims_wavenum ( 1 , 1 ) = nu_min band_lims_wavenum ( 2 , 1 ) = ( nus ( 1 ) + nus ( 2 )) * 0.5_wp ! Middle bands: edges at midpoints do inu = 2 , nnu - 1 band_lims_wavenum ( 1 , inu ) = ( nus ( inu - 1 ) + nus ( inu )) * 0.5_wp band_lims_wavenum ( 2 , inu ) = ( nus ( inu ) + nus ( inu + 1 )) * 0.5_wp end do ! Last band: ends at nu_max band_lims_wavenum ( 1 , nnu ) = ( nus ( nnu - 1 ) + nus ( nnu )) * 0.5_wp band_lims_wavenum ( 2 , nnu ) = nu_max ! ! Initialize the parent class error_msg = this % ty_optical_props % init ( band_lims_wavenum , name = \"ssm\" ) if ( error_msg /= '' ) return ! Now you can get dnus from the initialized structure: this % dnus = band_lims_wavenum ( 2 , :) - band_lims_wavenum ( 1 , :) ! Set molar masses based on gas names ! Maybe this is better as module data... do igas = 1 , ngas select case ( trim ( lower_case ( gas_names ( igas )))) case ( 'h2o' ) this % mol_weights ( igas ) = mw_h2o case ( 'co2' ) this % mol_weights ( igas ) = mw_co2 case ( 'o3' ) this % mol_weights ( igas ) = mw_o3 case default error_msg = \"Don't know the molecular weight for gas: \" // trim ( gas_names ( igas )) return end select end do if ( error_msg /= '' ) return ! Compute absorption coefficients by summing exponentials at each nu ! Initialize absorption coefficients to zero this % absorption_coeffs (:,:) = 0._wp do itri = 1 , size ( triangle_params , 1 ) ! Loop over triangles igas = int ( triangle_params ( itri , 1 )) ! Identify which gas this triangle corresponds to do inu = 1 , nnu ! Loop over wavenumber this % absorption_coeffs ( igas , inu ) = & this % absorption_coeffs ( igas , inu ) + & triangle_params ( itri , 2 ) * exp ( - abs ( this % nus ( inu ) - triangle_params ( itri , 3 )) / triangle_params ( itri , 4 )) end do end do if ( present ( Tstar )) this % Tstar = Tstar if ( present ( tsi )) this % tsi = tsi if ( present ( kappa_cld )) then this % kappa_cld = kappa_cld else this % kappa_cld = 0._wp end if if ( present ( g_cld )) then this % g_cld = g_cld else this % g_cld = 0._wp end if if ( present ( ssa_cld )) then this % ssa_cld = ssa_cld else this % ssa_cld = 0._wp end if end function configure_with_values !-------------------------------------------------------------------------------------------------------------------- ! !> Compute gas optical depth and Planck source functions, !>  given temperature, pressure, and composition ! function gas_optics_int ( this , & play , plev , tlay , tsfc , gas_desc , & optical_props , sources , & col_dry , tlev ) result ( error_msg ) ! inputs class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ), dimension (:,:), intent ( in ) :: play , & !! layer pressures [Pa]; (ncol,nlay) plev , & !! level pressures [Pa]; (ncol,nlay+1) tlay !! layer temperatures [K]; (ncol,nlay) real ( wp ), dimension (:), intent ( in ) :: tsfc !! surface skin temperatures [K]; (ncol) type ( ty_gas_concs ), intent ( in ) :: gas_desc !! Gas volume mixing ratios ! output class ( ty_optical_props_arry ), & intent ( inout ) :: optical_props !! Optical properties class ( ty_source_func_lw ), & intent ( inout ) :: sources !! Planck sources character ( len = 128 ) :: error_msg !! Empty if succssful ! Optional inputs real ( wp ), dimension (:,:), intent ( in ), & optional , target :: col_dry , & !! Column dry amount; dim(ncol,nlay), will be ignored tlev !! level temperatures [K]; (ncol,nlay+1) ! ---------------------------------------------------------- ! Local variables ! ---------------------------------------------------------- integer :: ncol , nlay , nnu , ngas integer :: igas , icol , ilay , idx_gas real ( wp ), dimension ( size ( this % gas_names ), size ( play , 1 ), size ( play , 2 )) :: layer_mass error_msg = \"\" ncol = size ( play , 1 ) nlay = size ( play , 2 ) nnu = size ( this % nus ) ngas = size ( this % gas_names ) call compute_layer_mass ( ncol , nlay , ngas , & this , plev , gas_desc , layer_mass , & error_msg ) if ( error_msg /= '' ) return ! ! Absorption optical depth ! call compute_tau ( ncol , nlay , nnu , ngas , & this % absorption_coeffs , play , this % pref , layer_mass , & optical_props % tau ) ! call optical_props % set_top_at_1 ( play ( 1 , 1 ) < play ( 1 , nlay )) select type ( optical_props ) type is ( ty_optical_props_2str ) call zero_array ( ncol , nlay , nnu , optical_props % ssa ) call zero_array ( ncol , nlay , nnu , optical_props % g ) type is ( ty_optical_props_nstr ) call zero_array ( ncol , nlay , nnu , optical_props % ssa ) call zero_array ( optical_props % get_nmom (), & ncol , nlay , nnu , optical_props % p ) end select ! ! Planck function sources call compute_Planck_source ( ncol , nlay , nnu , & this % nus , this % dnus , tlay , & sources % lay_source ) ! This will fail if Tlev isn't provided !   There's interpolation code in RRTMGP gas optics - !   should we make this generic and package it with the gas optics type? call compute_Planck_source ( ncol , nlay + 1 , nnu , & this % nus , this % dnus , tlev , & sources % lev_source ) call compute_Planck_source ( ncol , nnu , & this % nus , this % dnus , tsfc , & sources % sfc_source ) call zero_array ( ncol , nnu , sources % sfc_source_Jac ) end function gas_optics_int !------------------------------------------------------------------------------------------ ! !> Compute gas optical depth given temperature, pressure, and composition !>    Top-of-atmosphere stellar insolation is also reported ! function gas_optics_ext ( this , & play , plev , tlay , gas_desc , & ! mandatory inputs optical_props , toa_src , & ! mandatory outputs col_dry ) result ( error_msg ) ! optional input class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ), dimension (:,:), intent ( in ) :: play , & !! layer pressures [Pa]; (ncol,nlay) plev , & !! level pressures [Pa]; (ncol,nlay+1) tlay !! layer temperatures [K]; (ncol,nlay) type ( ty_gas_concs ), intent ( in ) :: gas_desc !! Gas volume mixing ratios ! output class ( ty_optical_props_arry ), & intent ( inout ) :: optical_props real ( wp ), dimension (:,:), intent ( out ) :: toa_src !! Incoming solar irradiance(ncol, nnu) character ( len = 128 ) :: error_msg !! Empty if successful ! Optional inputs real ( wp ), dimension (:,:), intent ( in ), & optional , target :: col_dry ! Column dry amount; dim(ncol,nlay) ! ---------------------------------------------------------- ! Local variables ! ---------------------------------------------------------- integer :: ncol , nlay , nnu , ngas integer :: igas , icol , ilay , idx_gas real ( wp ), dimension ( size ( this % gas_names ), size ( play , 1 ), size ( play , 2 )) :: layer_mass error_msg = \"\" ncol = size ( play , 1 ) nlay = size ( play , 2 ) nnu = size ( this % nus ) ngas = size ( this % gas_names ) call compute_layer_mass ( ncol , nlay , ngas , & this , plev , gas_desc , layer_mass , & error_msg ) if ( error_msg /= '' ) return ! ! Absorption optical depth ! call compute_tau ( ncol , nlay , nnu , ngas , & this % absorption_coeffs , play , this % pref , layer_mass , & optical_props % tau ) ! call optical_props % set_top_at_1 ( play ( 1 , 1 ) < play ( 1 , nlay )) ! Not doing scattering of gases select type ( optical_props ) type is ( ty_optical_props_2str ) call zero_array ( ncol , nlay , nnu , optical_props % ssa ) call zero_array ( ncol , nlay , nnu , optical_props % g ) type is ( ty_optical_props_nstr ) call zero_array ( ncol , nlay , nnu , optical_props % ssa ) call zero_array ( optical_props % get_nmom (), & ncol , nlay , nnu , optical_props % p ) end select ! ! Shortwave: incoming solar irradiance ! call compute_Planck_source ( ncol , nnu , & this % nus , this % dnus , spread ( this % Tstar , 1 , ncol ), & toa_src ) ! Make sure that the integral is the tsi toa_src = toa_src / spread ( sum ( toa_src , dim = 2 ), dim = 2 , ncopies = size ( toa_src , 2 )) * this % tsi end function gas_optics_ext !------------------------------------------------------------------------------------------ ! !> Derive cloud optical properties from provided cloud physical properties ! function cloud_optics ( this , & clwp , ciwp , reliq , reice , & optical_props ) result ( error_msg ) class ( ty_optics_ssm ), & intent ( in ) :: this real ( wp ), intent ( in ) :: clwp (:,:), & ! cloud liquid water path (g/m2) ciwp (:,:), & ! cloud ice water path    (g/m2) reliq (:,:), & ! cloud liquid particle effective size (microns) reice (:,:) ! cloud ice particle effective radius  (microns) class ( ty_optical_props_arry ), & intent ( inout ) :: optical_props character ( len = 128 ) :: error_msg ! ---------------------------------------------------------- ! Local variables ! ---------------------------------------------------------- error_msg = \"\" ! Get cloud optical depth by multiplying ! [kg/m2] of cloud by [m2/kg] absorption coeff ! Need spread because tau is 3D and cwp is 2D optical_props % tau = spread ( 100 0._wp * ( clwp + ciwp ) * this % kappa_cld , 3 , size ( this % nus )) select type ( optical_props ) type is ( ty_optical_props_2str ) optical_props % ssa = this % ssa_cld optical_props % g = this % g_cld type is ( ty_optical_props_nstr ) ! Toss an error here? No one uses n-streams end select end function cloud_optics !-------------------------------------------------------------------------------------------------------------------- ! ! Inquiry functions ! !-------------------------------------------------------------------------------------------------------------------- ! !> return true if initialized for internal sources/longwave, false otherwise ! pure function source_is_internal ( this ) class ( ty_optics_ssm ), intent ( in ) :: this logical :: source_is_internal source_is_internal = ( this % Tstar <= 0._wp ) end function source_is_internal !-------------------------------------------------------------------------------------------------------------------- ! !> return true if configured for external sources/shortwave, false otherwise ! pure function source_is_external ( this ) class ( ty_optics_ssm ), intent ( in ) :: this logical :: source_is_external source_is_external = ( this % Tstar > 0._wp ) end function source_is_external !-------------------------------------------------------------------------------------------------------------------- ! ! Boilerplate functions - not relevant for SSM ! !-------------------------------------------------------------------------------------------------------------------- ! !> Minimum valid pressure ! pure function get_press_min ( this ) class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ) :: get_press_min !! minimum valid pressure get_press_min = 0._wp end function get_press_min !-------------------------------------------------------------------------------------------------------------------- ! !> Maximum valid pressure ! pure function get_press_max ( this ) class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ) :: get_press_max !! maximum valid pressure get_press_max = huge ( 1._wp ) end function get_press_max !-------------------------------------------------------------------------------------------------------------------- ! !> Minimum valid temperature ! pure function get_temp_min ( this ) class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ) :: get_temp_min !! minimum valid temperature get_temp_min = 0._wp end function get_temp_min !-------------------------------------------------------------------------------------------------------------------- ! !> Maximum valid pressure ! pure function get_temp_max ( this ) class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ) :: get_temp_max !! maximum valid pressure get_temp_max = huge ( 1._wp ) end function get_temp_max !-------------------------------------------------------------------------------------------------------------------- ! !> Compute layer masses from gas concentrations and pressure levels ! subroutine compute_layer_mass ( ncol , nlay , ngas , this , plev , gas_desc , layer_mass , error_msg ) integer , intent ( in ) :: ncol , nlay , ngas class ( ty_optics_ssm ), intent ( in ) :: this real ( wp ), dimension (:,:), intent ( in ) :: plev !! level pressures [Pa]; (ncol,nlay+1) type ( ty_gas_concs ), intent ( in ) :: gas_desc !! Gas volume mixing ratios real ( wp ), dimension (:,:,:), intent ( out ) :: layer_mass !! (ngas, ncol, nlay) character ( len = 128 ), intent ( out ) :: error_msg integer :: igas , icol , ilay real ( wp ), dimension ( size ( layer_mass , 1 ), size ( layer_mass , 2 ), size ( layer_mass , 3 )) :: vmr error_msg = \"\" vmr (:,:,:) = 0._wp ! Get vmr if gas is provided in ty_gas_concs do igas = 1 , ngas if ( any ( lower_case ( this % gas_names ( igas )) == gas_desc % get_gas_names ())) then error_msg = gas_desc % get_vmr ( this % gas_names ( igas ), vmr ( igas ,:,:)) if ( error_msg /= '' ) return endif end do ! Convert pressures and vmr to layer masses (ngas, ncol, nlay) ! mmr = vmr * (Mgas/Mair) ! layer_mass = mmr * dp / g do ilay = 1 , nlay do icol = 1 , ncol do igas = 1 , ngas layer_mass ( igas , icol , ilay ) = vmr ( igas , icol , ilay ) * & ( this % mol_weights ( igas ) / this % m_dry ) * & abs ( plev ( icol , ilay + 1 ) - plev ( icol , ilay )) / grav end do end do end do end subroutine compute_layer_mass end module mo_optics_ssm","tags":"","loc":"sourcefile/mo_optics_ssm.f90.html"}]}